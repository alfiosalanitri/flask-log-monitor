{% extends 'base.html' %}
{% block content %}
<h2 class="text-2xl font-semibold mb-6 text-cyan-400 tracking-wide flex items-center gap-2">
  <i data-lucide="terminal-square" class="w-6 h-6 text-cyan-400"></i>
  Real-time logs
</h2>

<form method="get" class="mb-6 flex space-x-2">
  <select name="user_id" class="bg-gray-800 text-gray-100 rounded-lg px-3 py-2">
    <option value="">All users</option>
    {% for user in users %}
      <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>{{ user.name }}</option>
    {% endfor %}
  </select>
  <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg px-4 py-2 font-semibold flex items-center gap-1">
    <i data-lucide="filter" class="w-4 h-4"></i> Filter
  </button>
</form>

<div id="log-container"
     class="w-full max-w-4xl flex flex-col space-y-4 overflow-y-auto rounded-xl p-2 h-[75vh]">
  {% for log in logs %}
    <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 shadow-sm">
      <!-- Header -->
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-2">
          <i data-lucide="user" class="w-5 h-5 text-cyan-400"></i>
          <span class="font-semibold text-cyan-400 text-lg">
            {{ log.user.name if log.user else 'Sconosciuto' }}
          </span>
        </div>
        <div class="text-xs text-gray-500 ml-4">
          {{ log.created_at.strftime('%d/%m/%Y %H:%M:%S') }}
        </div>
      </div>

      <div class="font-mono text-sm mb-2 flex items-center gap-2">
        <span class="text-gray-400">Log level:</span>
        {% set level_icon = {
          'debug': 'bug',
          'info': 'info',
          'notice': 'info',
          'warning': 'alert-triangle',
          'error': 'x-circle',
          'critical': 'alert-octagon',
          'alert': 'bell',
          'emergency': 'flame'
        }[log.level] or 'dot' %}
        <i data-lucide="{{ level_icon }}"
           class="w-4 h-4
           {% if log.level == 'debug' %}text-gray-400
           {% elif log.level == 'info' %}text-sky-400
           {% elif log.level == 'notice' %}text-blue-300
           {% elif log.level == 'warning' %}text-yellow-400
           {% elif log.level == 'error' %}text-red-400
           {% elif log.level == 'critical' %}text-red-500
           {% elif log.level == 'alert' %}text-orange-400
           {% elif log.level == 'emergency' %}text-red-600
           {% else %}text-gray-300{% endif %}">
        </i>
        <span class="
          {% if log.level == 'debug' %}text-gray-400
          {% elif log.level == 'info' %}text-sky-400
          {% elif log.level == 'notice' %}text-blue-300
          {% elif log.level == 'warning' %}text-yellow-400
          {% elif log.level == 'error' %}text-red-400
          {% elif log.level == 'critical' %}text-red-500 font-semibold
          {% elif log.level == 'alert' %}text-orange-400 font-semibold
          {% elif log.level == 'emergency' %}text-red-600 font-bold
          {% else %}text-gray-200{% endif %}
        ">
          {{ log.level.upper() }}
        </span>
      </div>

      <div data-log-message class="bg-gray-800/50 rounded-lg p-3 text-sm font-mono text-gray-200 max-h-96 overflow-y-auto whitespace-pre-wrap">
        {{ log.message }}
      </div>

      {% if log.context %}
        <div class="mt-3 bg-gray-950 border border-gray-800 rounded-lg p-3 text-xs font-mono text-cyan-200 overflow-x-auto">
          <pre>{{ log.context | tojson(indent=2) }}</pre>
        </div>
      {% endif %}
    </div>
  {% endfor %}
</div>

<!-- Socket live -->
<script>
  const socket = io();
  const container = document.getElementById('log-container');

  socket.on('new_log', (data) => {
    const wrapper = document.createElement('div');
    wrapper.className = "bg-gray-900 border border-gray-800 rounded-xl p-4 shadow-sm animate-fade-in";

    const colorClass = {
      debug: "text-gray-400",
      info: "text-sky-400",
      notice: "text-blue-300",
      warning: "text-yellow-400",
      error: "text-red-400",
      critical: "text-red-500 font-semibold",
      alert: "text-orange-400 font-semibold",
      emergency: "text-red-600 font-bold",
      log: "text-gray-200"
    }[data.level.toLowerCase()] || "text-gray-200";

    const icon = {
      debug: "bug",
      info: "info",
      notice: "info",
      warning: "alert-triangle",
      error: "x-circle",
      critical: "alert-octagon",
      alert: "bell",
      emergency: "flame"
    }[data.level.toLowerCase()] || "dot";

    const createdAt = new Date(data.created_at || Date.now()).toLocaleString('it-IT');

    wrapper.innerHTML = `
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-2">
          <i data-lucide="user" class="w-5 h-5 text-cyan-400"></i>
          <span class="font-semibold text-cyan-400 text-lg">${data.user}</span>
        </div>
        <div class="text-xs text-gray-500 ml-4">${createdAt}</div>
      </div>
      <div class="font-mono text-sm mb-2 flex items-center gap-2">
        <span class="text-gray-400">Livello log:</span>
        <i data-lucide="${icon}" class="w-4 h-4 ${colorClass.replace('font-semibold', '')}"></i>
        <span class="${colorClass}">${data.level.toUpperCase()}</span>
      </div>
      <div class="bg-gray-800/50 rounded-lg p-3 text-sm font-mono text-gray-200 max-h-96 overflow-y-auto whitespace-pre-wrap">
        ${formatMessage(data.message)}
      </div>

      ${data.context ? `
        <div class="mt-3 bg-gray-950 border border-gray-800 rounded-lg p-3 text-xs font-mono text-cyan-200 overflow-x-auto">
          <pre>${JSON.stringify(data.context, null, 2)}</pre>
        </div>
        ` : ""}
    `;

    container.insertBefore(wrapper, container.firstChild);
    lucide.createIcons(wrapper);
  });

  document.querySelectorAll('[data-log-message]').forEach(el => {
    el.textContent = formatMessage(el.textContent);
  });

  function formatMessage(message) {
    if (typeof message !== 'string') {
      return JSON.stringify(message, null, 2);
    }

    const trimmed = message.trim();

    if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
      try {
        const parsed = JSON.parse(trimmed);
        return JSON.stringify(parsed, null, 2);
      } catch (e) {
        // Non è JSON valido → ritorna testo originale
        return message;
      }
    }

    return message;
  }

</script>

<style>
  @keyframes fade-in {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in { animation: fade-in 0.3s ease-out; }
</style>
{% endblock %}
